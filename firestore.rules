rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ──────────────────────────────────────────────────────

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }

    function hasRole(role) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isCOSOrAdmin() {
      let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      return isAuthenticated() && (userRole == 'ADMIN' || userRole == 'COS');
    }

    // ── Users ─────────────────────────────────────────────────────────────────
    // Ogni utente può leggere/scrivere solo il proprio documento.
    // Gli admin possono leggere tutti.
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ── Events (Dossier) ──────────────────────────────────────────────────────
    // Lettura: tutti gli utenti autenticati.
    // Scrittura: solo ADMIN.
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ── OKRs ──────────────────────────────────────────────────────────────────
    match /okrs/{okrId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ── Signals ───────────────────────────────────────────────────────────────
    match /signals/{signalId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ── Decisions ─────────────────────────────────────────────────────────────
    match /decisions/{decisionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ── Reports ───────────────────────────────────────────────────────────────
    // Reports are created client-side (read-only function result). All authenticated users
    // can write their own reports. Admin can delete.
    match /reports/{reportId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ── Daily Pulse (legacy — kept for backward compat) ───────────────────────
    match /daily_pulse/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ── Daily Plans (new — Steering workspace) ────────────────────────────────
    // COS and ADMIN can create and update steering plans.
    // All authenticated users can read.
    match /daily_plans/{docId} {
      allow read: if isAuthenticated();
      allow write: if isCOSOrAdmin();
    }

    // ── Weekly Plans (new — Steering workspace) ───────────────────────────────
    match /weekly_plans/{docId} {
      allow read: if isAuthenticated();
      allow write: if isCOSOrAdmin();
    }

    // ── Strategic Themes (new) ────────────────────────────────────────────────
    // Only ADMIN can create/update strategic themes (C-suite level decision).
    match /strategic_themes/{themeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ── AI Insights (Human-in-the-Loop triage) ─────────────────────────────
    // COS and Admin can read and write. Used for AI-generated intuitions
    // that require human validation before being promoted to signals/decisions.
    match /ai_insights/{insightId} {
      allow read: if isCOSOrAdmin();
      allow write: if isCOSOrAdmin();
    }

    // ── Intelligence Archives (Long-term Research Memory) ────────────────────
    // Stores completed web research reports for long-term retrieval and RAG.
    // Read/write: COS and ADMIN only. Client can create (after research completes).
    //
    // Document structure:
    //   title:            string   — report topic/title
    //   content:          string   — full Markdown text of the report
    //   sourceUrls:       string[] — URLs cited in the report
    //   timestamp:        timestamp
    //   relatedDossierId: string?  — dossier context if research was scoped
    //   createdBy:        string   — UID of the user who triggered the research
    //   reportType:       string   — "strategic" | "competitive" | "market"
    match /intelligence_archives/{archiveId} {
      allow read: if isCOSOrAdmin();
      allow create: if isCOSOrAdmin();
      allow update, delete: if isAdmin();
    }

    // ── Pending AI Actions (HITL — Human-in-the-Loop) ───────────────────────
    // AI proposes actions but does NOT write directly to production collections.
    // Instead it creates a record here with status "pending".
    // The human CoS/Admin approves (→ executes) or rejects (→ discards).
    //
    // Document structure:
    //   id:             auto-generated
    //   proposedAction: string  — human-readable description of what the AI wants to do
    //   payload:        object  — structured params for the action (tool name + args)
    //   contextId:      string? — optional dossier/event ID this action relates to
    //   status:         "pending" | "approved" | "rejected"
    //   summary:        string  — short 1-line label shown in the HITL tile
    //   createdAt:      timestamp
    //   resolvedAt:     timestamp? — set when approved or rejected
    //   resolvedBy:     string?   — UID of user who resolved
    //
    // Security: only COS and ADMIN can see and interact with AI proposals.
    // Cloud Functions (Admin SDK) write the initial "pending" record.
    // Client can update status to "approved" or "rejected" (resolution only).
    match /pending_ai_actions/{actionId} {
      allow read: if isCOSOrAdmin();
      allow create: if false;                  // Only Cloud Functions (Admin SDK) create
      allow update: if isCOSOrAdmin()          // Client can only resolve (approve/reject)
        && request.resource.data.status in ["approved", "rejected"]
        && resource.data.status == "pending";  // Can only transition from pending
      allow delete: if isAdmin();              // Admin can purge old records
    }

    // ── Audit Logs ───────────────────────────────────────────────────────────
    // CLIENT CANNOT WRITE. Only Admin SDK (Cloud Functions) can write via bypass.
    // Admin can read for security review and analytics.
    // IMPORTANT: This rule blocks direct client writes; Cloud Functions use admin.firestore()
    // which bypasses these rules by design — that is the intended security model.
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only Admin SDK in Cloud Functions
    }

    // ── Shadow CoS Chat History ───────────────────────────────────────────────
    // Each user can read/write only their own chat history document.
    match /shadow_cos_prefs/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ── Briefings ────────────────────────────────────────────────────────────
    match /briefings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // generated by client after Cloud Function returns
    }

    // ── Invites ───────────────────────────────────────────────────────────────
    // Lettura pubblica necessaria per validare il token sull'onboarding (/join).
    // Scrittura (generazione/consumo): solo ADMIN o utente autenticato (consumo).
    match /invites/{inviteId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAuthenticated(); // consumeInvite incrementa useCount
      allow delete: if isAdmin();
    }

    // ── Stakeholders ──────────────────────────────────────────────────────────
    // Write: COS or Admin (relationship management is COS responsibility).
    match /stakeholders/{stakeholderId} {
      allow read: if isAuthenticated();
      allow write: if isCOSOrAdmin();
    }

    // ── Meetings ──────────────────────────────────────────────────────────────
    // Write: COS or Admin.
    match /meetings/{meetingId} {
      allow read: if isAuthenticated();
      allow write: if isCOSOrAdmin();
    }

  }
}
